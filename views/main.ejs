<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
  <script type="text/javascript" src="http://code.jquery.com/jquery-latest.js"></script>

  <style>
    @import url(http://fonts.googleapis.com/earlyaccess/notosanskr.css);
    @import url(//fonts.googleapis.com/earlyaccess/jejugothic.css);
    @import url('https://fonts.googleapis.com/css?family=Amatic+SC|Baloo+Tammudu|Delius+Unicase|Griffy|Lobster|Pacifico');
    @import url(//cdn.rawgit.com/hiun/NanumSquare/master/nanumsquare.css);

    #header {
      font-family: 'Amatic SC', cursive;
      height: 50px;
      width: 100%;
      position: fixed;
      background: #fff;
      box-shadow: 0 0 5px rgba(57, 70, 78, .2);
      z-index: 999;
      margin-top: -20px;
    }

    #header_btn {
      font-family: 'Noto Sans KR', sans-serif;
      vertical-align: middle;
      float: right;
      padding-top: 5px;
      padding-right: 1%;
    }

    #sidebar {
      font-family: 'Noto Sans KR', sans-serif;
      padding: 0;
      margin: 0;
      width: 350px;
      position: fixed;
      top: 50px;
      left: 0;
      padding: 1%;
      border-right: solid 1px #e9eced;
      height: calc(100vh - 55px);
      background: #fff;
      display: flex;
      flex-direction: column;
      background-color: #eee;
    }

    #content {
      padding-top: 55px;
      padding-left: 380px;
      padding-right: 3%;
      margin-left: 1%;
      margin: 1%;
      font-family: 'Noto Sans KR', sans-serif;
    }

    table,
    td {
      padding: 5px;
    }

    hr {
      margin-right: 2%;
      margin-left: 2%;
    }

    ul {
      list-style-type: none;
      padding: 1;
    }

    li {
      list-style-type: none;
      padding-left: 1.3em;
      line-height: 2em;
      cursor: pointer;
    }

    li:before {
      font-family: FontAwesome;
      content: "\f101";
      /* FontAwesome Unicode */
      display: inline-block;
      left: 15px;
      width: 1.3em;
    }

    .x_btn {
      font-family: FontAwesome;
      content: "\f00d";
      border: none;
      /*---테두리 정의---*/
      display: block;
      color: red;
      background-color: #eee;
      cursor: pointer;
      position: fixed;
      margin-top: -35px;
      left: 275px;
      width: 40px;
      height: 30px;
    }

    .btn_content {
      font-family: FontAwesome;
      background-color: white;
      border: 1px solid #aaaaaa;
      display: block;
      margin-left: 50%;
      width: 20%;
      transform: translate(-50%);
      color: #525252;
      padding: 0.5%;
      box-shadow: 0 0 5px rgba(57, 70, 78, .2);
      cursor: pointer;
    }
  </style>


  <title>SCRAMBLE</title>
</head>

<body>
  <div style="" id="header">
    <div id="header_logo" style="font-weight:bold; letter-spacing: 10px; font-size:35px; height:0px ">
      <img style="margin-left:50px;" src="https://image.flaticon.com/icons/svg/540/540209.svg" width="40px" height="40px"> SCRAMBLE
    </div>

    <div style="" id="header_btn">

    </div>
  </div>

  <div id="" style="-webkit-overflow-scrolling: touch;">
    <form action id="sidebar">
      <table border="0" class="text-center">
        <tr>
          <td style="width:250px; line-height:1.0em ">
            <input type="text" size="8" id="name" class="form-control" placeholder="웹페이지 이름을 입력하세요." /> </br>
            <input type="text" id="address" class="form-control" placeholder="웹페이지 주소를 입력하세요." />
          </td>
          <td style="width:70px" rowspan="2" padding=5px>
            <input type="button" class="btn btn-success" style="height:90px" id="address_regist" value="등록" />
          </td>
        </tr>
      </table>
      <hr style="border: 0; height: 2px; background-image: -webkit-linear-gradient(left, #f0f0f0, #8c8b8b, #f0f0f0); background-image: -moz-linear-gradient(left, #f0f0f0, #8c8b8b, #f0f0f0); background-image: -ms-linear-gradient(left, #f0f0f0, #8c8b8b, #f0f0f0); background-image: -o-linear-gradient(left, #f0f0f0, #8c8b8b, #f0f0f0); "
      />
      <div id="name_list">
      </div>
    </form>
    <div id="content" style="">
      <div id="login_form">
        <h1 style="text-align:center;font-family: 'Pacifico', cursive;font-size:50px">
                    </br>
                    </br> Welcome to SCRAMBLE</h1>
        </br>
        </br>
        <table style="text-align:center;margin-left:50%;transform:translate(-50%);">
          <tr>
            <td><input type="email" style="clear:both;width:100%;max-width:400px;height:50px;margin-left:50%;transform:translate(-50%)" class="form-control" id="userId" placeholder="Input your Email"></br>
              <input type="password" style="clear:both;width:400px;height:50px;margin-left:50%;transform:translate(-50%)" class="form-control" id="password" placeholder="Input your Password"></td>
            <td rowspan="2"><input type="submit" id="login_submit" class="btn btn-warning" style="width:80px; height:120px" value="Login" /></td>
          </tr>
          <tr>
        </table>
        </br><button type="button" style="font-size:17px; width:180px; height:50px; margin-left:50%; transform:translate(-50%);cursor:pointer" onclick="popup_signup();">Signup</button>
      </div>
    </div>

    <script>
      var token = '';
      var userId = '';
      var new_token = '';

      $(document).ready(function() {
        $("#close").click(function() {
          $("#popup").hide();
        })
      })

      // window.onload = function () {
      //     let name_list = sessionStorage.getItem("name_list");
      //     new_token = sessionStorage.getItem("new_token");
      //     if (new_token !== '')
      //     {
      //         token = new_token;
      //         $("#content").remove();
      //         $("#header_btn").append('<input type="button" id="logout_submit" class="btn btn-warning" style="width:90px;" value="로그아웃"/>');
      //         $("#name_list").append(name_list);
      //     }
      // }

      function popup_signup() {
        window.open("signup", "회원가입", 'left=' + (screen.availWidth - 460) / 2 + ',top=' + (screen.availHeight - 550) / 2 + ', width=460px,height=550px');
      }

      $("#login_submit").click(function() {
        userId = $("#userId").val();
        $.ajax({
          url: '/users/loginOk',
          dataType: 'json',
          type: 'POST',
          data: {
            'userId': userId,
            'password': $("#password").val()
          },
          success: function(res) {
            if (res['isOK'] == true) {
              alert('로그인되었습니다.');
              $("#login_form").remove();
              $("#header_btn").append('<input type="button" id="logout_submit" class="btn btn-warning" style="width:90px;" value="로그아웃"/>  &nbsp;&nbsp;');
              token = res['token'];
              let url_name = '';
              let url_address = '';
              let url_id = '';
              let feed_id = null;
              if (res.urlData != '') {
                for (var i = 0; i < res.urlData.length; i++) {
                  url_id = res.urlData[i].Id;
                  url_name = res.urlData[i].name;
                  url_address = res.urlData[i].address;
                  $("#name_list").append('<li id="' + i + '" onclick="read_feeds(' + feed_id + ',' + url_id + ');">' + url_name + '</li>');
                  $("#name_list").append('<input type="button" class="x_btn" value="&#61453" id="delete_' + i + '" onclick="delete_name(' + url_id + ',' + i + ');" >');
                }
              }
            } else {
              alert('아이디 또는 비밀번호가 없습니다.');
            }
          },
          error: function(error) {
            alert("Error!");
          }
        })
      })

      $("#address_regist").click(function() {
        if (token == '') {
          alert('로그인해주세요.');
          $('#name').val('');
          $("#address").val('');
        } else {
          let name = $("#name").val();
          let address = $("#address").val();
          rss_check(name, address);
          $('#name').val('');
          $("#address").val('');
        }
      })

      var rss_check = function(name, address) {
        if (token == '') {
          alert('로그인해주세요.');
        } else {
          $.ajax({
            url: '/urls/validateUrl',
            dataType: 'json',
            type: 'POST',
            headers: {
              'x-access-token': token
            },
            data: {
              'address': address
            },
            success: function(res) {
              console.log(res);
              if (res['isOK'] == true) {
                insert_names(name, address);
              } else {
                alert("등록에 실패했습니다.");
              }
            }
          })
        }
      }

      var insert_names = function(name, address) {
        if (token == '') {
          alert('로그인해주세요.');
        } else {
          $.ajax({
            url: '/urls',
            dataType: 'json',
            type: 'POST',
            headers: {
              'x-access-token': token
            },
            data: {
              'name': name,
              'address': address,
              'userId': userId
            },
            success: function(res) {
              if (res['isOK'] == true) {
                $("#name_list").empty();
                let url_name = '';
                let url_address = '';
                let url_id = '';
                let feed_id = null;
                for (let i = 0; i < res.urls.length; i++) {
                  url_name = res.urls[i].name;
                  url_address = res.urls[i].address;
                  url_id = res.urls[i].Id;
                  $("#name_list").append('<li id="' + i + '" onclick="read_feeds(' + feed_id + ',' + url_id + ');">' + url_name + '</li>');
                  $("#name_list").append('<input type="button" class="x_btn" value="&#61453" id="delete_' + i + '" onclick="delete_name(' + url_id + ',' + i + ');" >');
                }
                init_feeds(url_id, url_address);
              }
            },
            error: function(error) {
              alert("웹페이지 이름을 불러올 수 없습니다.");
            }
          })
        }
      }

      var init_feeds = function(url_id, url_address) {
        if (token == '') {
          alert('로그인해주세요.');
        } else {
          $.ajax({
            url: '/feeds/init',
            dataType: 'json',
            type: 'POST',
            headers: {
              'x-access-token': token
            },
            data: {
              'urlId': url_id,
              'address': url_address
            },
            success: function(res) {
              if (res['isOK'] == true) {
                alert("등록되었습니다.");
              }
            },
            error: function(error) {
              alert("첫 피드를 불러올 수 없습니다.");
            }
          })
        }
      }

      var read_feeds = function(feed_id, url_id) {
        $("#more").remove();
        if (feed_id == null) {
          $("#content").empty();
        }
        if (token == '') {
          alert('로그인해주세요.');
        } else {
          $.ajax({
            url: '/feeds',
            dataType: 'json',
            type: 'POST',
            headers: {
              'x-access-token': token
            },
            data: {
              'feedId': feed_id,
              'urlId': url_id
            },
            success: function(res) {
              console.log(res);
              if (res.length == 10) {
                feed_id = res[res.length - 1].Id;
                for (let i = 0; i < res.length; i++) {
                  let title = res[i].title;
                  let content = res[i].content;
                  let url = res[i].link;
                  console.log(url);
                  $("#content").append('<div id="feed_' + i + '" > <a style="font-weight:bold; font-size:22px;" href="' + url + '" target="_blank">' + title + '</a> <p>' + content + '</p> </div>');
                  $("#content").append('<hr style="margin-left:-5px;margin-right:-5px;"></hr>');
                }
                $("#content").append('<input type="button" id="more"  class="btn_content" onclick="read_feeds(' + feed_id + ',' + url_id + ');" value="더보기  &#61560"/>');
              } else if (res.length < 10) {
                $("#more").remove();
                $("#content").append('<input type="button" id="check"  class="btn_content"  onclick="read_check(' + url_id + ');" value="읽음  &#61713"/>');
              } else if (res == null) {
                $("#more").remove();
                $("#content").append('<input type="button" id="check" class="btn_content"  onclick="read_check(' + url_id + ');" value="읽음  &#61713"/>');
              }
            }

          })
        }
      }

      var read_check = function(url_id) {
        if (token == '') {
          alert('로그인해주세요.');
        } else {
          $.ajax({
            url: '/urls/state/' + url_id,
            dataType: 'json',
            type: 'PUT',
            headers: {
              'x-access-token': token
            },
            data: {
              'Id': url_id
            },
            success: function(res) {
              if (res['isOK'] == true) {
                $("#content").empty();
              }
            }
          })
        }
      }

      var delete_name = function(url_id, i) {
        if (token == '') {
          alert('로그인해주세요.');
        } else {
          if (confirm("정말 삭제하시겠습니까?") == true) {
            $.ajax({
              url: '/urls/delete/' + url_id,
              dataType: 'json',
              type: 'DELETE',
              headers: {
                'x-access-token': token
              },
              success: function(res) {
                $("#" + i).remove();
                $("#delete_" + i).remove();
                $("#content").empty();
              },
              error: function(error) {
                alert("삭제할 수 없습니다.");
              }
            })
          } else return;
        }
      }

      // window.onbeforeunload = function () {
      //     sessionStorage.setItem("name_list", $("#name_list").html());
      //     sessionStorage.setItem("new_token", token);
      // }
    </script>

</body>

</html>
