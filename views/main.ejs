<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M"
        crossorigin="anonymous">
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
    <script type="text/javascript" src="http://code.jquery.com/jquery-latest.js"></script>

    <style>
        @import url(http://fonts.googleapis.com/earlyaccess/notosanskr.css);
        @import url(//fonts.googleapis.com/earlyaccess/jejugothic.css);
        @import url('https://fonts.googleapis.com/css?family=Amatic+SC|Baloo+Tammudu|Delius+Unicase|Griffy|Lobster|Pacifico');
        @import url(//cdn.rawgit.com/hiun/NanumSquare/master/nanumsquare.css);

        #header {
            /*font-family: 'Baloo Tammudu', cursive;
      font-family: 'Lobster', cursive;
      font-family: 'Griffy', cursive;
      font-family: 'Pacifico', cursive;
      font-family: 'Amatic SC', cursive;
      font-family: 'Delius Unicase', cursive;*/
            /*font-family: 'Jeju Gothic', sans-serif;*/
            font-family: 'Amatic SC', cursive;
            /*font-family: 'Baloo Tammudu', cursive;*/
            height: 50px;
            background: #fff;
            box-shadow: 0 0 5px rgba(57, 70, 78, .2);
            z-index: 100;
            padding-top: 5px;
        }

        #header_btn {
            font-family: 'Noto Sans KR', sans-serif;
            vertical-align: middle;
            float: right;
            padding-top: 5px;
            padding-right: 1%;
        }

        #sidebar {
            font-family: 'Noto Sans KR', sans-serif;
            padding: 0;
            margin: 0;
            width: 350px;
            position: absolute;
            top: 50px;
            left: 0;
            padding: 1%;
            border-right: solid 1px #e9eced;
            height: calc(100vh - 55px);
            background: #fff;
            display: flex;
            flex-direction: column;
            background-color: #eee;
        }

        #content {
            padding-left: 360px;
            padding-right: 2%;
            margin: 1%;
            font-family: 'Nanum Square';
        }

        table,
        td {
            padding: 5px;
        }

        hr {
            margin-right: 2%;
            margin-left: 2%;
        }

        ul {
            /*파비콘으로 리스트 표시하기?*/
            list-style-image: url('http://www.google.com/s2/favicons?domain_url=http://www.naver.com');
        }
    </style>
    <!-- 
    <script>
        var didScroll = false;

        $(window).scroll(function(){ didScroll = true; });
    </script> -->

    <title>SCRAMBLE</title>
</head>

<body>
    <div id="header">
        <div id="header_logo" style="font-weight:bold; letter-spacing: 10px ;  margin-top:-5px; font-size:35px; height:0px ">
            <img style="margin-left:50px; margin-top:-5px" src="https://image.flaticon.com/icons/svg/540/540209.svg" width="40px" height="40px">            SCRAMBLE
        </div>

        <div id="header_btn">
            <div id="login_form" class="form-inline">
                <div class="form-group">
                    <input type="email" class="form-control" id="userId" placeholder="이메일을 입력해주세요">&nbsp;&nbsp;
                </div>
                <div class="form-group">
                    <input type="password" class="form-control" id="password" placeholder="비밀번호를 입력해주세요">&nbsp;&nbsp;
                </div>
                <input type="submit" id="login_submit" class="btn btn-warning" style="width:90px;" value="로그인" /> &nbsp;&nbsp;
                <button class="btn" style="width:90px;" onclick="popup_signup();">회원가입</button></br>
            </div>
        </div>
    </div>
    <div id="" style="-webkit-overflow-scrolling: touch;">
        <form action id="sidebar">
            <table border="0" class="text-center">
                <tr>
                    <td style="width:250px; line-height:1.0em ">
                        <input type="text" size="8" id="name" class="form-control" placeholder="웹페이지 이름을 입력하세요." /> </br>
                        <input type="text" id="address" class="form-control" placeholder="웹페이지 주소를 입력하세요." />
                    </td>
                    <td style="width:70px" rowspan="2" padding=5px>
                        <input type="button" class="btn btn-success" style="height:90px" id="address_regist" value="등록" />
                    </td>
                </tr>
            </table>
            <hr style="size:9px" />
            <div id="name_list">
            </div>
        </form>
        <div id="content">
            <!-- feed추가되는부분 -->
            안녕하세요! 메인페이지입니다!!
        </div>
    </div>

    <script>
        var token = '';
        var userId = '';

        $(document).ready(function (res) {
            $("#close").click(function () {
                $("#popup").hide();
            })
        })

        function popup_signup() {
            window.open("signup", "회원가입",
                'left=' + (screen.availWidth - 460) / 2 + ',top=' + (screen.availHeight - 550) / 2 + ', width=460px,height=550px');
        }

        $("#login_submit").click(function () {
            userId = $("#userId").val();
            $.ajax({
                url: '/users/loginOk',
                dataType: 'json',
                type: 'POST',
                data: { 'userId': userId, 'password': $("#password").val() },
                success: function (res) {
                    if (res['isOK'] == true) {
                        alert('로그인되었습니다.');
                        $("#login_form").remove();
                        $("#header_btn").append('<input type="submit" id="login_submit" class="btn btn-warning" style="width:90px;" value="로그아웃"/>  &nbsp;&nbsp;');
                        token = res['token'];
                        let url_name = '';
                        let url_address = '';
                        let url_id = '';
                        if (res.urlData != '') {
                            for (var i = 0; i < res.urlData.length; i++) {
                                url_id = res.urlData[i].Id;
                                url_name = res.urlData[i].name;
                                url_address = res.urlData[i].address;
                                console.log(url_name);
                                $("#name_list").append('<ul id="' + i + '" onclick="read_feeds(' + url_id + ');">' + url_name + '</ul>');
                                $("#name_list").append('<input type="button" id="delete_' + i + '" onclick="delete_name(' + url_id + ',' + i + ');" value="삭제">');
                            }
                        }
                    }
                    else {
                        alert('아이디 또는 비밀번호가 없습니다.');
                    }
                },
                error: function (error) {
                    alert("Error!");
                }
            })
        })

        $("#address_regist").click(function () {
            if (token == '') {
                alert('로그인해주세요.');
            }
            else {
                let name = $("#name").val();
                let address = $("#address").val();
                $('#name').val('');
                $("#address").val('');
                insert_names(name, address);
            }
        })

        var insert_names = function (name, address) {
            if (token == '') {
                alert('로그인해주세요.');
            }
            else {
                $.ajax({
                    url: '/urls',
                    dataType: 'json',
                    type: 'POST',
                    headers: { 'x-access-token': token },
                    data: { 'name': name, 'address': address, 'userId': userId },
                    success: function (res) {
                        if (res['isOK'] == true) {
                            $("#name_list").empty();
                            let url_name = '';
                            let url_address = '';
                            let url_id = '';
                            for (let i = 0; i < res.urls.length; i++) {
                                url_name = res.urls[i].name;
                                url_address = res.urls[i].address;
                                url_id = res.urls[i].Id;
                                $("#name_list").append('<ul id="' + i + '" onclick="read_feeds(' + url_id + ');">' + url_name + '</ul>');
                                $("#name_list").append('<input type="button" id="delete_' + i + '" onclick="delete_name(' + url_id + ',' + i + ');" value="삭제">');
                            }
                            init_feeds(url_id, url_address);
                        }
                    },
                    error: function (error) {
                        alert("웹페이지 이름을 불러올 수 없습니다.");
                    }
                })
            }
        }

        var init_feeds = function (url_id, url_address) {
            if (token == '') {
                alert('로그인해주세요.');
            }
            else {
                $.ajax({
                    url: '/feeds/init',
                    dataType: 'json',
                    type: 'POST',
                    headers: { 'x-access-token': token },
                    data: { 'urlId': url_id, 'address': url_address },
                    success: function (res) {
                        if (res['isOK'] == true) {
                            alert("등록되었습니다.");
                        }
                        else {
                            alert("등록에 실패했습니다.");
                        }
                    },
                    error: function (error) {
                        alert("첫 피드를 불러올 수 없습니다.");
                    }
                })
            }
        }


        var read_feeds = function (url_id) {
            if (token == '') {
                alert('로그인해주세요.');
            }
            else {
                $.ajax({
                    url: '/feeds/' + url_id,
                    dataType: 'json',
                    type: 'GET',
                    headers: { 'x-access-token': token },
                    success: function (res) {
                        $("#content").empty();
                        var i = 0;
                        for (i = res.length - 1; i >= 0; i--) {
                            var title = res[i].title;
                            var content = res[i].content;
                            var url = res[i].link;
                            $("#content").append('<div id="feed_' + i + '" > <a style="font-weight:bold; font-size:22px;" href="' + url + '">' + title + '</a> <p>' + content + '</p> </div>');
                        }
                        // if (didScroll == true){
                        //     alert('스크롤 끝 지점입니다.');
                        // }
                        // if (i > 0) {
                        //     $("#content").append('<input type="button" onclick="more_feeds(' + res + ',' + i + ');" value="더보기"/>');
                        // }
                    }
                })
            }
        }

        // var more_feeds = function (res, i) {
        //     while(true){
        //         var j = 0;
        //         for (j = i - 1; j > i - 10; i--){
        //             var title = res[i].title;
        //             var content = res[i].content;
        //             var url = res[i].link;
        //             $("#content").append('<div id="feed_' + j + '" > <a style="font-weight:bold; font-size:22px;" href="' + url + '">' + title + '</a> <p>' + content + '</p> </div>');

        //             if (j == 0){
        //                 break;
        //             }
        //         }
        //         if (j > 0) {
        //             $("#content").append('<input type="button" onclick="more_feeds(' + res + ',' + j + ');" value="더보기"/>');
        //         }
        //         else {
        //             break;
        //         }
        //     }
        // }

        var delete_name = function (url_id, i) {
            if (token == '') {
                alert('로그인해주세요.');
            }
            else {
                $.ajax({
                    url: '/urls/delete/' + url_id,
                    dataType: 'json',
                    type: 'DELETE',
                    headers: { 'x-access-token': token },
                    success: function (res) {
                        $("#" + i).remove();
                        $("#delete_" + i).remove();
                        $("#content").empty();
                    },
                    error: function (error) {
                        alert("삭제할 수 없습니다.");
                    }
                })
            }
        }
    </script>

</body>

</html>